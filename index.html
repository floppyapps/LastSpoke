<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LastSpoke</title>

  <!-- PWA manifest & icons -->
  <link rel="manifest" href="manifest.json"/>
  <meta name="theme-color" content="#ff4081"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <link rel="apple-touch-icon" href="icons/icon-192.png"/>

  <!-- Friendly font -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700&display=swap" rel="stylesheet"/>

  <style>
    /* --- Auth Overlay --- */
    html,body {margin:0;padding:0;height:100%;}
    #auth-overlay {
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:white;display:flex;flex-direction:column;
      justify-content:center;align-items:center;font-family:Arial,sans-serif;
      z-index:10000;
    }
    #auth-overlay h2 {margin-bottom:16px;}
    #auth-overlay input {margin:4px;padding:8px;width:220px;font-size:1em;}
    #auth-overlay button {margin:6px;padding:8px 16px;font-size:1em;cursor:pointer;}

    /* --- App Container (hidden until auth) --- */
    #app-container { display:none; }

    /* --- Core App Styles --- */
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 15px; user-select: none; }
    h1.app-title { font-family:'Nunito',sans-serif; font-size:2em; text-align:center; margin-bottom:12px; }
    #login-status {
      text-align:center; color:#555; margin-bottom:12px;
      display:flex; justify-content:center; align-items:center; gap:8px;
    }
    #login-status button {
      padding:4px 10px; cursor:pointer; border:none; background:#ff4081; color:white; border-radius:4px;
    }
    #column-labels { display:grid; grid-template-columns:1fr 48px 48px; gap:24px; margin-bottom:8px; padding:0 12px; }
    #column-labels .label { text-align:center; font-size:0.8em; line-height:1.2em; }
    #contacts-list { margin-bottom:100px; }
    .contact-row {
      display:grid; grid-template-columns:1fr 48px 48px; gap:24px; align-items:center;
      border:1px solid #ccc; padding:8px 12px; margin-bottom:12px; border-radius:8px; background:#fff;
    }
    .contact-name { white-space:pre-line; font-weight:bold; cursor:pointer; line-height:1.2em; overflow-wrap:break-word; }
    .circle-btn {
      width:48px;height:48px;border-radius:50%;border:none;color:white;font-weight:bold;font-size:1em;
      cursor:pointer;transition:filter .2s;
    }
    .circle-btn:active { filter:brightness(.8); }
    .talked-btn { background:#d27fff; }
    .seen-btn   { background:#3CB371; }
    #add-contact-plus {
      position:fixed; bottom:20px; left:20px; width:56px;height:56px;border-radius:50%;
      background:#ff4081;color:white;font-size:36px;line-height:56px;text-align:center;
      cursor:pointer;box-shadow:0 4px 8px rgba(255,64,129,.3);z-index:9999;
    }
    #modal-overlay {
      display:none; position:fixed; top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,.3); backdrop-filter:blur(3px); z-index:5000;
      display:flex;justify-content:center;align-items:center;
    }
    #modal {
      background:white;padding:20px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.2);
      width:90%;max-width:320px;display:flex;gap:10px;align-items:center;
    }
    #modal input {
      flex:1;font-size:1.1em;padding:8px 12px;border:1px solid #ccc;border-radius:6px;
    }
    #modal button {
      width:48px;height:48px;border-radius:50%;background:#ff4081;color:white;border:none;
      font-size:28px;cursor:pointer;box-shadow:0 4px 8px rgba(255,64,129,.4);
    }
    #calendar {
      display:none!important; /* hidden until invoked */
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      background:white;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.3);
      padding:16px;z-index:6000;display:flex;flex-direction:column;align-items:center;
    }
    #calendar-header {
      display:flex;align-items:center;gap:6px;width:100%;margin-bottom:8px;
    }
    #calendar-header button {
      background:transparent;border:none;font-size:18px;cursor:pointer;color:#555;transition:color .2s;
    }
    #calendar-header button:hover { color:#ff4081; }
    #calendar-month-year { flex:1;text-align:center;font-weight:bold;font-size:1.1em; }
    #clear-date {
      font-size:24px;color:#555;padding:4px 8px;border:none;background:transparent;cursor:pointer;transition:color .2s;
    }
    #clear-date:hover { color:#ff4081; }
    #calendar-days,#calendar-dates {
      display:grid;grid-template-columns:repeat(7,1fr);gap:4px;width:100%;text-align:center;
    }
    #calendar-days div { font-weight:bold;color:#777; }
    #calendar-dates button {
      background:transparent;border:none;padding:6px 0;border-radius:6px;
      cursor:pointer;transition:background .3s,color .3s;color:#444;
    }
    #calendar-dates button:hover { background:#ffccdc;color:#ff4081; }
    #calendar-dates button.selected { background:#ff4081;color:white;font-weight:bold; }
    #calendar-dates button:disabled { color:#ccc;cursor:default; }
  </style>
</head>

<body>
  <!-- Auth Overlay -->
  <div id="auth-overlay">
    <h2>Welcome to LastSpoke</h2>
    <input id="email-input"  type="email"    placeholder="Email"/>
    <input id="pass-input"   type="password" placeholder="Password"/>
    <button id="btn-signup">Sign Up &amp; Verify</button>
    <button id="btn-signin">Sign In</button>
    <button id="btn-guest">Continue as Guest</button>
  </div>

  <!-- Main App Container -->
  <div id="app-container">
    <h1 class="app-title">LastSpoke</h1>
    <div id="login-status"></div>

    <div id="column-labels">
      <div></div><div class="label">Last<br>Spoke</div><div class="label">Last<br>Seen</div>
    </div>

    <div id="contacts-list" aria-live="polite"></div>
    <div id="add-contact-plus">+</div>

    <div id="modal-overlay">
      <div id="modal">
        <input id="modal-contact-name" placeholder="Enter contact name" maxlength="40"/>
        <button id="modal-add-btn">+</button>
      </div>
    </div>

    <div id="calendar">
      <div id="calendar-header">
        <button id="prev-year">«</button>
        <button id="prev-month">‹</button>
        <div id="calendar-month-year"></div>
        <button id="next-month">›</button>
        <button id="next-year">»</button>
        <button id="clear-date" title="Clear date">—</button>
      </div>
      <div id="calendar-days">
        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div>
        <div>Thu</div><div>Fri</div><div>Sat</div>
      </div>
      <div id="calendar-dates"></div>
    </div>
  </div>

  <script type="module">
    // Firebase imports
    import { initializeApp }         from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInAnonymously,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      signOut, sendEmailVerification
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getFirestore, doc, onSnapshot, setDoc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCVt7xEfSIuevmDg7g_P-euAzru1wKfbgc",
      authDomain: "lastspoke-pwa.firebaseapp.com",
      projectId: "lastspoke-pwa",
      storageBucket: "lastspoke-pwa.appspot.com",
      messagingSenderId: "281416737434",
      appId: "1:281416737434:web:969c036b12a1c2e5a8f523"
    };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Auth UI elements
    const authOv   = document.getElementById('auth-overlay');
    const emailIn  = document.getElementById('email-input');
    const passIn   = document.getElementById('pass-input');
    const btnSU    = document.getElementById('btn-signup');
    const btnSI    = document.getElementById('btn-signin');
    const btnG     = document.getElementById('btn-guest');
    const appCont  = document.getElementById('app-container');
    const loginSt  = document.getElementById('login-status');

    // Sign-up (with verification)
    btnSU.onclick = () => {
      createUserWithEmailAndPassword(auth, emailIn.value.trim(), passIn.value)
        .then(cred => sendEmailVerification(cred.user).then(() => alert("Verification email sent!")))
        .catch(e => alert("Sign-up error: " + e.message));
    };
    // Sign-in
    btnSI.onclick = () => {
      signInWithEmailAndPassword(auth, emailIn.value.trim(), passIn.value)
        .catch(e => alert("Sign-in error: " + e.message));
    };
    // Guest
    btnG.onclick = () => signInAnonymously(auth).catch(console.error);

    // After auth state changes
    let unsubscribeFromCloud = null;
    onAuthStateChanged(auth, user => {
      if (user && (user.isAnonymous || user.emailVerified)) {
        // Show app
        authOv.style.display  = 'none';
        appCont.style.display = 'block';
        // Show status + buttons
        loginSt.innerHTML = user.isAnonymous
          ? 'Signed in as Guest'
          : `Signed in as ${user.email}`;
        loginSt.insertAdjacentHTML('beforeend', '<button id="btn-signout-app">Sign Out</button>');
        document.getElementById('btn-signout-app')
          .onclick = () => signOut(auth);
        if (user.isAnonymous) {
          loginSt.insertAdj
