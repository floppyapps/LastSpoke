<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LastSpoke</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json"/>
  <meta name="theme-color" content="#ff4081"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <link rel="apple-touch-icon" href="icons/icon-192.png"/>

  <!-- Friendly rounded font -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700&display=swap" rel="stylesheet"/>

  <style>
    body { font-family: Arial,sans-serif; max-width:600px; margin:0 auto; padding:15px; user-select:none; }
    h1.app-title { font-family:'Nunito',sans-serif; font-size:2em; text-align:center; margin-bottom:12px; }
    /* Login UI */
    #login-ui { text-align:center; margin-bottom:12px; }
    #login-ui input { margin:0 4px; padding:4px 8px; }
    #login-ui button { margin:0 4px; padding:6px 12px; cursor:pointer; }
    /* Column labels */
    #column-labels { display:grid; grid-template-columns:1fr 48px 48px; gap:24px; margin-bottom:8px; padding:0 12px; }
    #column-labels .label { text-align:center; font-size:0.8em; line-height:1.2em; }
    /* Contacts */
    #contacts-list { margin-bottom:100px; }
    .contact-row { display:grid; grid-template-columns:1fr 48px 48px; gap:24px; align-items:center;
      border:1px solid #ccc; padding:8px 12px; margin-bottom:12px; border-radius:8px; background:#fff; }
    .contact-name { white-space:pre-line; font-weight:bold; cursor:pointer; line-height:1.2em; overflow-wrap:break-word; }
    .circle-btn { width:48px;height:48px;border-radius:50%;border:none;color:white;font-weight:bold;font-size:1em;
      cursor:pointer;transition:filter .2s; }
    .circle-btn:active { filter:brightness(.8); }
    .talked-btn { background:#d27fff; }
    .seen-btn   { background:#3CB371; }
    /* “+” */
    #add-contact-plus { position:fixed; bottom:20px; left:20px; width:56px;height:56px; border-radius:50%;
      background:#ff4081; color:white; font-size:36px; line-height:56px; text-align:center; cursor:pointer;
      box-shadow:0 4px 8px rgba(255,64,129,.3); z-index:1000; }
    /* Modal overlay */
    #modal-overlay { display:none; position:fixed; top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,.3); backdrop-filter:blur(3px); z-index:2000; display:flex; justify-content:center; align-items:center; }
    #modal { background:white; padding:20px; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,.2);
      width:90%; max-width:320px; display:flex; gap:10px; align-items:center; }
    #modal input { flex:1; font-size:1.1em; padding:8px 12px; border-radius:6px; border:1px solid #ccc; }
    #modal button { width:48px;height:48px;border-radius:50%;background:#ff4081;color:white;border:none;
      font-size:28px; cursor:pointer; box-shadow:0 4px 8px rgba(255,64,129,.4); }
    /* Calendar */
    #calendar { display:none; position:fixed; top:50%;left:50%; transform:translate(-50%,-50%);
      background:white; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.3); padding:16px; z-index:3000;
      display:flex; flex-direction:column; align-items:center; }
    #calendar-header { display:flex; align-items:center; gap:6px; width:100%; margin-bottom:8px; }
    #calendar-header button { background:transparent;border:none;font-size:18px;cursor:pointer;color:#555;transition:color .2s; }
    #calendar-header button:hover { color:#ff4081; }
    #calendar-month-year { flex:1; text-align:center; font-weight:bold; font-size:1.1em; }
    #clear-date { font-size:24px;color:#555;padding:4px 8px;border:none;background:transparent;cursor:pointer;transition:color .2s; }
    #clear-date:hover { color:#ff4081; }
    #calendar-days, #calendar-dates { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; width:100%; text-align:center; }
    #calendar-days div { font-weight:bold;color:#777; }
    #calendar-dates button { background:transparent;border:none;padding:6px 0;border-radius:6px;cursor:pointer;
      transition:background .3s,color .3s;color:#444; }
    #calendar-dates button:hover { background:#ffccdc;color:#ff4081; }
    #calendar-dates button.selected { background:#ff4081;color:white;font-weight:bold; }
    #calendar-dates button:disabled { color:#ccc;cursor:default; }
  </style>
</head>
<body>

  <h1 class="app-title">LastSpoke</h1>

  <!-- Auth UI -->
  <div id="login-ui">
    <input id="email-input" type="email" placeholder="Email"/>
    <input id="pass-input" type="password" placeholder="Password"/>
    <button id="btn-signup">Sign Up</button>
    <button id="btn-signin">Sign In</button>
    <button id="btn-logout" style="display:none;">Sign Out</button>
  </div>

  <!-- Headers -->
  <div id="column-labels">
    <div></div><div class="label">Last<br>Spoke</div><div class="label">Last<br>Seen</div>
  </div>

  <!-- List & “+” -->
  <div id="contacts-list" aria-live="polite"></div>
  <div id="add-contact-plus">+</div>

  <!-- Add Modal -->
  <div id="modal-overlay">
    <div id="modal">
      <input id="modal-contact-name" placeholder="Enter contact name" maxlength="40"/>
      <button id="modal-add-btn">+</button>
    </div>
  </div>

  <!-- Calendar Modal -->
  <div id="calendar">
    <div id="calendar-header">
      <button id="prev-year">«</button>
      <button id="prev-month">‹</button>
      <div id="calendar-month-year"></div>
      <button id="next-month">›</button>
      <button id="next-year">»</button>
      <button id="clear-date" title="Clear date">—</button>
    </div>
    <div id="calendar-days">
      <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div>
      <div>Thu</div><div>Fri</div><div>Sat</div>
    </div>
    <div id="calendar-dates"></div>
  </div>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInAnonymously,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      signOut, sendEmailVerification
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc }
      from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // Init
    const firebaseConfig = {
      apiKey: "AIzaSyCVt7xEfSIuevmDg7g_P-euAzru1wKfbgc",
      authDomain: "lastspoke-pwa.firebaseapp.com",
      projectId: "lastspoke-pwa",
      storageBucket: "lastspoke-pwa.appspot.com",
      messagingSenderId: "281416737434",
      appId: "1:281416737434:web:969c036b12a1c2e5a8f523"
    };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    console.log("App loaded");

    // Auth UI refs
    const emailIn   = document.getElementById('email-input'),
          passIn    = document.getElementById('pass-input'),
          btnSignup = document.getElementById('btn-signup'),
          btnSignin = document.getElementById('btn-signin'),
          btnLogout = document.getElementById('btn-logout');

    // Anonymous sign-in
    signInAnonymously(auth).catch(e=>console.error("Anon failed",e));

    btnSignup.onclick = ()=>{
      console.log("Sign-up");
      createUserWithEmailAndPassword(auth,emailIn.value,passIn.value)
        .then(cred=>{
          console.log("Signed up",cred.user.uid);
          sendEmailVerification(cred.user).then(()=>alert("Verify email sent"));
        })
        .catch(e=>{console.error(e);alert(e.message);});
    };
    btnSignin.onclick = ()=>{
      console.log("Sign-in");
      signInWithEmailAndPassword(auth,emailIn.value,passIn.value)
        .then(cred=>console.log("Signed in",cred.user.uid))
        .catch(e=>{console.error(e);alert(e.message);});
    };
    btnLogout.onclick = ()=>{ console.log("Sign-out"); signOut(auth); };

    let unsubscribeFromCloud;
    onAuthStateChanged(auth,user=>{
      console.log("Auth",user?.uid);
      if(user){
        document.getElementById('login-ui').style.display='none';
        btnLogout.style.display='';
        startCloudSync(user.uid);
      } else {
        document.getElementById('login-ui').style.display='';
        btnLogout.style.display='none';
        stopCloudSync();
      }
    });

    // App logic
    const KEY='contactTrackerData';
    let contacts=JSON.parse(localStorage.getItem(KEY)||'[]');
    let calIdx,calField,calYear,calMonth,calSel;
    const listEl=document.getElementById('contacts-list'),
          plusBtn=document.getElementById('add-contact-plus'),
          modalOv=document.getElementById('modal-overlay'),
          modalIn=document.getElementById('modal-contact-name'),
          modalAdd=document.getElementById('modal-add-btn'),
          calEl=document.getElementById('calendar'),
          lblCY=document.getElementById('calendar-month-year'),
          pYr=document.getElementById('prev-year'),
          nYr=document.getElementById('next-year'),
          pMo=document.getElementById('prev-month'),
          nMo=document.getElementById('next-month'),
          clearBtn=document.getElementById('clear-date'),
          datesGr=document.getElementById('calendar-dates');

    function save(){ localStorage.setItem(KEY,JSON.stringify(contacts)); }
    function daysSince(d){ return d?Math.floor((Date.now()-new Date(d))/86400000):'—'; }
    function fmtName(n){
      const w=n.trim().split(' ');
      if(w.length>1){
        let f=w[0],s=w.slice(1).join(' ');
        if(f.length>20){s=f.slice(20)+' '+s;f=f.slice(0,20);}
        if(s.length>20) s=s.slice(0,20)+'…';
        return f+'\n'+s;
      }
      return n.length>20?n.slice(0,20)+'…':n;
    }

    function render(){
      listEl.innerHTML='';
      contacts.forEach((c,i)=>{
        const row=document.createElement('div');row.className='contact-row';
        const nm=document.createElement('div');nm.className='contact-name';
        nm.textContent=fmtName(c.name);
        let dt;
        nm.addEventListener('pointerdown',()=>{
          dt=setTimeout(()=>{
            if(confirm(`Delete "${c.name}"?`)){
              contacts.splice(i,1);save();render();
            }
          },700);
        });
        ['pointerup','pointerleave','pointercancel'].forEach(e=>nm.addEventListener(e,()=>clearTimeout(dt)));
        row.appendChild(nm);
        ['lastTalked','lastSeen'].forEach(fld=>{
          const btn=document.createElement('button');
          btn.className='circle-btn '+(fld==='lastTalked'?'talked-btn':'seen-btn');
          btn.textContent=daysSince(c[fld]);
          let down,tm;
          btn.addEventListener('pointerdown',()=>{
            down=Date.now();tm=setTimeout(()=>openCal(i,fld),700);
          });
          ['pointerup','pointerleave','pointercancel'].forEach(e=>btn.addEventListener(e,()=>{
            clearTimeout(tm);
            if(Date.now()-down<700){
              c[fld]=new Date().toISOString().slice(0,10);
              if(fld==='lastSeen'&&c.lastTalked!==null){
                const s=new Date(c.lastSeen),sp=new Date(c.lastTalked);
                if(s>sp) c.lastTalked=c.lastSeen;
              }
              save();render();
            }
          }));
          row.appendChild(btn);
        });
        listEl.appendChild(row);
      });
    }

    plusBtn.addEventListener('click',()=>{
      modalOv.style.display='flex';modalIn.value='';modalIn.focus();plusBtn.style.display='none';
    });
    modalAdd.addEventListener('click',()=>{
      const v=modalIn.value.trim();if(!v){alert('Enter name');return;}
      contacts.push({name:v,lastTalked:null,lastSeen:null});save();render();
      modalOv.style.display='none';plusBtn.style.display='block';
    });
    modalOv.addEventListener('click',e=>{
      if(e.target===modalOv){
        modalOv.style.display='none';
        plusBtn.style.display='block';
      }
    });

    function openCal(idx,fld){
      calIdx=idx;calField=fld;
      calSel=contacts[idx][fld]||new Date().toISOString().slice(0,10);
      const d=new Date(calSel);
      calYear=d.getFullYear();calMonth=d.getMonth();
      drawCal();calEl.style.display='flex';
    }
    function drawCal(){
      lblCY.textContent=new Date(calYear,calMonth)
        .toLocaleDateString(undefined,{year:'numeric',month:'long'});
      datesGr.innerHTML='';
      const first=new Date(calYear,calMonth,1),
            last=new Date(calYear,calMonth+1,0),
            start=first.getDay(),today=new Date(),
            minSpoke=(calField==='lastTalked'&&contacts[calIdx].lastSeen)
              ? new Date(contacts[calIdx].lastSeen):null;
      for(let i=0;i<start;i++) datesGr.appendChild(document.createElement('div'));
      for(let d=1;d<=last.getDate();d++){
        const b=document.createElement('button');b.textContent=d;
        const dt=new Date(calYear,calMonth,d);
        if(dt>today||(minSpoke&&dt<minSpoke)) b.disabled=true;
        else b.addEventListener('click',()=>{
          const mo=String(calMonth+1).padStart(2,'0'),
                da=String(d).padStart(2,'0');
          contacts[calIdx][calField]=`${calYear}-${mo}-${da}`;
          if(calField==='lastSeen'&&contacts[calIdx].lastTalked!==null){
            const s=new Date(contacts[calIdx].lastSeen),
                  sp=new Date(contacts[calIdx].lastTalked);
            if(s>sp) contacts[calIdx].lastTalked=contacts[calIdx].lastSeen;
          }
          save();render();closeCal();
        });
        const [y,m,day]=calSel.split('-');
        if(+y===calYear&&+m-1===calMonth&&+day===d) b.classList.add('selected');
        datesGr.appendChild(b);
      }
    }
    pMo.onclick=()=>{calMonth--;if(calMonth<0){calMonth=11;calYear--;}drawCal();};
    nMo.onclick=()=>{calMonth++;if(calMonth>11){calMonth=0;calYear++;}drawCal();};
    pYr.onclick=()=>{calYear--;drawCal();};
    nYr.onclick=()=>{calYear++;drawCal();};
    clearBtn.addEventListener('click',()=>{
      if(calField==='lastSeen') contacts[calIdx].lastSeen=null;
      else contacts[calIdx].lastTalked=null;
      save();render();closeCal();
    });
    document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeCal(); });
    function closeCal(){ calEl.style.display='none'; }

    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>{
        navigator.serviceWorker.register('service-worker.js').catch(console.error);
      });
    }

    render();

    function startCloudSync(uid){
      const userDoc=doc(db,'users',uid);
      unsubscribeFromCloud=onSnapshot(userDoc,snap=>{
        if(snap.exists()){ contacts=snap.data().contacts||[]; render(); }
      });
      save=()=>{
        localStorage.setItem(KEY,JSON.stringify(contacts));
        setDoc(userDoc,{contacts});
      };
    }
    function stopCloudSync(){
      if(unsubscribeFromCloud) unsubscribeFromCloud();
      save=()=>localStorage.setItem(KEY,JSON.stringify(contacts));
    }
  </script>

</body>
</html>
